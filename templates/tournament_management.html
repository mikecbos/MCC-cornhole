{% extends "layout.html" %}
{% block title %}Tournament Management{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Tournament Management</h1>

    <!-- Button to create a new tournament -->
    <div class="mb-3">
        <a href="{{ url_for('tournament_config') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Create New Tournament
        </a>
    </div>

    <h2>Existing Tournaments</h2>
    {% if tournaments %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Default</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for tournament in tournaments %}
                <tr>
                    <td>{{ tournament.name }}</td>
                    <td>{{ tournament.type.replace('_', ' ').title() }}</td>
                    <td>
                         {% if tournament.status == 'completed' %}
                            <span class="badge bg-success">{{ tournament.status.title() }}</span>
                        {% elif tournament.status == 'active' %}
                            <span class="badge bg-primary">{{ tournament.status.title() }}</span>
                        {% elif tournament.status == 'paused' %}
                            <span class="badge bg-secondary">{{ tournament.status.title() }}</span>
                        {% else %} {# Default for pending etc. #}
                            <span class="badge bg-warning text-dark">{{ tournament.status.title() }}</span>
                        {% endif %}
                    </td>
                    <td>{{ tournament.created_at.strftime('%Y-%m-%d %H:%M') if tournament.created_at else 'N/A' }}</td>
                    <td>
                         {% if tournament.is_default %}
                            <i class="fas fa-star text-warning" title="Current Default"></i>
                        {% else %}
                            <form action="{{ url_for('set_default_tournament', tournament_id=tournament.id) }}" method="POST" class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="btn btn-sm btn-outline-warning" title="Set as Default">
                                    <i class="far fa-star"></i> Set
                                </button>
                            </form>
                        {% endif %}
                    </td>
                    <td class="action-cell">
                        <a href="{{ url_for('tournament_view', tournament_id=tournament.id) }}" class="btn btn-sm btn-info me-1" title="View/Manage Bracket">
                            <i class="fas fa-sitemap"></i> View
                        </a>
                        
                        <button type="button" class="btn btn-sm btn-primary me-1"
                                data-bs-toggle="modal"
                                data-bs-target="#editTournamentModal"
                                data-tournament-id="{{ tournament.id }}"
                                data-tournament-name="{{ tournament.name }}"
                                title="Edit Tournament Name">
                            <i class="fas fa-edit"></i> Edit Name
                        </button>

                        <div class="dropdown d-inline">
                            <button class="btn btn-sm btn-secondary dropdown-toggle me-1" type="button" id="statusDropdown{{ tournament.id }}" data-bs-toggle="dropdown" aria-expanded="false" data-bs-boundary="viewport" title="Change Status">
                                <i class="fas fa-sliders-h"></i> Status
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="statusDropdown{{ tournament.id }}">
                                 {% if tournament.status != 'active' and tournament.status != 'completed' %}
                                <li>
                                    <form action="{{ url_for('set_tournament_status', tournament_id=tournament.id) }}" method="POST">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <input type="hidden" name="new_status" value="active"/>
                                        <button type="submit" class="dropdown-item"><i class="fas fa-play-circle text-primary me-2"></i>Set Active</button>
                                    </form>
                                </li>
                                {% endif %}
                                {% if tournament.status == 'active' %}
                                <li>
                                     <form action="{{ url_for('set_tournament_status', tournament_id=tournament.id) }}" method="POST">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <input type="hidden" name="new_status" value="paused"/>
                                        <button type="submit" class="dropdown-item"><i class="fas fa-pause-circle text-secondary me-2"></i>Set Paused</button>
                                    </form>
                                </li>
                                {% endif %}
                                {% if tournament.status == 'paused' %}
                                 <li>
                                     <form action="{{ url_for('set_tournament_status', tournament_id=tournament.id) }}" method="POST">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <input type="hidden" name="new_status" value="active"/>
                                        <button type="submit" class="dropdown-item"><i class="fas fa-play-circle text-primary me-2"></i>Set Active</button>
                                    </form>
                                </li>
                                {% endif %}
                                {% if tournament.status != 'pending' and tournament.status != 'completed' %} {# Allow reset to pending unless completed #}
                                <li>
                                     <form action="{{ url_for('set_tournament_status', tournament_id=tournament.id) }}" method="POST">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <input type="hidden" name="new_status" value="pending"/>
                                        <button type="submit" class="dropdown-item"><i class="fas fa-undo text-warning me-2"></i>Set Pending</button>
                                    </form>
                                </li>
                                {% endif %}
                                {% if tournament.status != 'completed' %} {# Allow manual completion #}
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                     <form action="{{ url_for('set_tournament_status', tournament_id=tournament.id) }}" method="POST">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <input type="hidden" name="new_status" value="completed"/>
                                        <button type="submit" class="dropdown-item"><i class="fas fa-check-circle text-success me-2"></i>Set Completed</button>
                                    </form>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                        
                        <form action="{{ url_for('delete_tournament', tournament_id=tournament.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete the tournament \'{{ tournament.name }}\' and ALL its matches? This cannot be undone.');">
                             <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                             <button type="submit" class="btn btn-sm btn-danger" title="Delete Tournament">
                                 <i class="fas fa-trash"></i> Delete
                             </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info" role="alert">
        No tournaments found. <a href="{{ url_for('tournament_config') }}">Create one now!</a>
    </div>
    {% endif %}
</div>

<!-- Edit Tournament Modal -->
<div class="modal fade" id="editTournamentModal" tabindex="-1" aria-labelledby="editTournamentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="editTournamentModalLabel">Edit Tournament Name</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin_tournaments_management') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="edit_tournament_name">
                <input type="hidden" id="edit_tournament_id" name="tournament_id">
                <div class="modal-body">
                    <p>Editing tournament: <strong id="editTournamentCurrentName" class="text-info"></strong></p>
                    <div class="mb-3">
                        <label for="edit_tournament_name_field" class="form-label">New Tournament Name</label>
                        <input type="text" class="form-control" id="edit_tournament_name_field" name="new_tournament_name" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block styles %}
<style>
    .table-responsive {
        overflow: visible !important; /* Ensures dropdowns are not clipped */
    }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const editTournamentModal = document.getElementById('editTournamentModal');
    if (editTournamentModal) {
        editTournamentModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const tournamentId = button.getAttribute('data-tournament-id');
            const tournamentName = button.getAttribute('data-tournament-name');

            editTournamentModal.querySelector('#editTournamentCurrentName').textContent = tournamentName;
            editTournamentModal.querySelector('#edit_tournament_id').value = tournamentId;
            editTournamentModal.querySelector('#edit_tournament_name_field').value = tournamentName;
        });
    }
    
    // --- Modal Accessibility Enhancement (copied from participant_management.html for consistency) ---
    function setupModalAccessibility() {
        let lastFocusedElement = null;
        const modals = document.querySelectorAll('.modal');

        modals.forEach(modal => {
            modal.addEventListener('show.bs.modal', function() {
                lastFocusedElement = document.activeElement;
            });

            modal.addEventListener('shown.bs.modal', function() {
                const cancelButton = modal.querySelector('.modal-footer .btn-secondary[data-bs-dismiss="modal"]');
                const primaryButton = modal.querySelector('.modal-footer .btn-primary, .modal-footer .btn-danger');
                const firstInput = modal.querySelector('input:not([type=hidden]), select, textarea');

                if (cancelButton) {
                    cancelButton.focus();
                } else if (primaryButton) {
                     primaryButton.focus();
                } else if (firstInput) {
                     firstInput.focus();
                } else {
                    modal.focus(); 
                }
            });

            modal.addEventListener('hidden.bs.modal', function() {
                if (lastFocusedElement) {
                    setTimeout(() => {
                        try {
                          lastFocusedElement.focus();
                        } catch (e) {
                            console.warn("Could not restore focus to:", lastFocusedElement, e);
                        }
                        lastFocusedElement = null;
                    }, 10);
                }
            });

             modal.querySelectorAll('.btn-close').forEach(btn => {
                 if (!btn.classList.contains('btn-close-white') && modal.classList.contains('bg-dark')) { // Check if modal is dark
                     btn.classList.add('btn-close-white');
                 }
                 if (!btn.hasAttribute('aria-label')) {
                    btn.setAttribute('aria-label', 'Close');
                 }
             });
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const visibleModal = document.querySelector('.modal.show');
                if (visibleModal) {
                    const modalInstance = bootstrap.Modal.getInstance(visibleModal);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }
            }
        });
    }
    setupModalAccessibility(); // Call it
});
</script>
{% endblock scripts %}