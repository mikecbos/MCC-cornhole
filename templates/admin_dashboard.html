{% extends 'base.html' %}

{% block title %}Admin Dashboard - Cornhole Tournament{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Admin Dashboard</h1>
    <a href="{{ url_for('new_tournament') }}" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
        Create New Tournament
    </a>
</div>

<!-- Active Tournament Section -->
{% if active_tournament %}
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">Active Tournament</h6>
        <span class="badge bg-success">Active</span>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-lg-8">
                <h4>{{ active_tournament.name }}</h4>
                {% if active_tournament.description %}
                    <p class="text-muted">{{ active_tournament.description }}</p>
                {% endif %}
                <div class="d-flex flex-wrap gap-3 mb-3">
                    <div class="d-flex align-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2 text-primary"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        <span>{{ active_teams|length }} Teams</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2 text-primary"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
                        <span>Max Teams: {{ active_tournament.max_teams }}</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2 text-primary"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        <span>Status: {{ active_tournament.status|title }}</span>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="d-grid gap-2">
                    {% if active_tournament.status == 'registration' %}
                        <a href="{{ url_for('admin_preview_bracket', tournament_id=active_tournament.id) }}" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            Preview & Generate Bracket
                        </a>
                        <button class="btn btn-outline-primary toggle-registration" data-tournament-id="{{ active_tournament.id }}" data-status="{% if active_tournament.registration_open %}close{% else %}open{% endif %}">
                            {% if active_tournament.registration_open %}
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                Close Registration
                            {% else %}
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                Open Registration
                            {% endif %}
                        </button>
                    {% elif active_tournament.status == 'in_progress' %}
                        <a href="{{ url_for('index') }}" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
                            View Bracket
                        </a>
                        <button class="btn btn-success update-status" data-tournament-id="{{ active_tournament.id }}" data-status="completed">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M20 6 9 17l-5-5"></path></svg>
                            Mark as Completed
                        </button>
                    {% else %}
                        <button class="btn btn-primary archive-tournament" data-tournament-id="{{ active_tournament.id }}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M4 11v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8H4Z"></path><path d="m21 7-9-4-9 4"></path><path d="M12 3v16"></path></svg>
                            Archive Tournament
                        </button>
                    {% endif %}
                    <a href="{{ url_for('edit_tournament', tournament_id=active_tournament.id) }}" class="btn btn-outline-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg>
                        Edit Tournament
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-info">
    <p>There is no active tournament. <a href="{{ url_for('new_tournament') }}">Create a new tournament</a> to get started.</p>
</div>
{% endif %}

<!-- Recent Registrations Section -->
{% if active_tournament %}
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Registered Teams</h6>
    </div>
    <div class="card-body">
        {% if active_teams %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Team Name</th>
                            <th>Player 1</th>
                            <th>Player 2</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for team in active_teams %}
                            <tr>
                                <td>{{ team.name }}</td>
                                <td>{{ team.player1.first_name }} {{ team.player1.last_name }}</td>
                                <td>
                                    {% if team.player2 %}
                                        {{ team.player2.first_name }} {{ team.player2.last_name }}
                                    {% elif team.waiting_for_teammate %}
                                        <span class="badge bg-warning text-dark">Waiting</span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if team.seed_number %}
                                        <span class="badge bg-info">Seed #{{ team.seed_number }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">No Seed</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-danger delete-team" data-team-id="{{ team.id }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-warning">
                <p>No teams have registered for this tournament yet.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Other Tournaments Section -->
{% if other_tournaments %}
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Other Tournaments</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Season</th>
                        <th>Status</th>
                        <th>Teams</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tournament in other_tournaments %}
                        <tr>
                            <td>{{ tournament.name }}</td>
                            <td>{{ tournament.season }} {{ tournament.year }}</td>
                            <td>
                                {% if tournament.is_archived %}
                                    <span class="badge bg-secondary">Archived</span>
                                {% else %}
                                    <span class="badge bg-info">{{ tournament.status | title }}</span>
                                {% endif %}
                            </td>
                            <td>{{ tournament.teams|length }} / {{ tournament.max_teams }}</td>
                            <td>
                                <div class="btn-group">
                                    <a href="{{ url_for('tournament_details', tournament_id=tournament.id) }}" class="btn btn-sm btn-primary">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                    </a>
                                    <a href="{{ url_for('edit_tournament', tournament_id=tournament.id) }}" class="btn btn-sm btn-info">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg>
                                    </a>
                                    {% if not tournament.is_archived %}
                                        <button class="btn btn-sm btn-success make-active" data-tournament-id="{{ tournament.id }}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 11-6 6v3h9l3-3"></path><path d="m17 5-1 1"></path><circle cx="19" cy="3" r="3"></circle><path d="m13 9-2 2"></path><circle cx="11" cy="11" r="2"></circle></svg>
                                        </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle registration status
        const toggleRegistrationButtons = document.querySelectorAll('.toggle-registration');
        toggleRegistrationButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tournamentId = this.dataset.tournamentId;
                const newStatus = this.dataset.status === 'open';
                
                fetch(`/admin/tournaments/${tournamentId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: `registration_open=${newStatus}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Failed to update registration status: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while updating the registration status.');
                });
            });
        });
        
        // Update tournament status
        const updateStatusButtons = document.querySelectorAll('.update-status');
        updateStatusButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tournamentId = this.dataset.tournamentId;
                const newStatus = this.dataset.status;
                
                fetch(`/admin/tournaments/${tournamentId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: `status=${newStatus}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Failed to update tournament status: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while updating the tournament status.');
                });
            });
        });
        
        // Archive tournament
        const archiveButtons = document.querySelectorAll('.archive-tournament');
        archiveButtons.forEach(button => {
            button.addEventListener('click', function() {
                if (confirm('Are you sure you want to archive this tournament? This will make it inactive.')) {
                    const tournamentId = this.dataset.tournamentId;
                    
                    fetch(`/admin/tournaments/${tournamentId}/archive`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Failed to archive tournament: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while archiving the tournament.');
                    });
                }
            });
        });
        
        // Make tournament active
        const makeActiveButtons = document.querySelectorAll('.make-active');
        makeActiveButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tournamentId = this.dataset.tournamentId;
                
                fetch(`/admin/tournaments/${tournamentId}/make-active`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Failed to make tournament active: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while updating active status.');
                });
            });
        });
        
        // Delete team
        const deleteTeamButtons = document.querySelectorAll('.delete-team');
        deleteTeamButtons.forEach(button => {
            button.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete this team?')) {
                    const teamId = this.dataset.teamId;
                    
                    fetch(`/admin/teams/${teamId}`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token() }}'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Failed to delete team: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the team.');
                    });
                }
            });
        });
    });
</script>
{% endblock %}