{% extends 'base.html' %}

{% block title %}Admin Dashboard - Cornhole Tournament{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Admin Dashboard</h1>
    <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-danger btn-sm">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
        Logout
    </a>
</div>

<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Active Tournament</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ active_tournament.name if active_tournament else 'None' }}</div>
                    </div>
                    <div class="col-auto">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Total Tournaments</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ tournaments|length }}</div>
                    </div>
                    <div class="col-auto">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><path d="M3 9h18"></path><path d="M9 3v18"></path></svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Actions
                        </div>
                        <div class="row no-gutters align-items-center">
                            <div class="col">
                                <a href="{{ url_for('new_tournament') }}" class="btn btn-sm btn-primary">Create Tournament</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            View Frontend</div>
                        <a href="{{ url_for('index') }}" class="btn btn-sm btn-outline-secondary">Go to Tournament</a>
                    </div>
                    <div class="col-auto">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300"><path d="M18 12L6 12"></path><path d="M14 16L18 12 14 8"></path></svg>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">Tournaments</h6>
        <a href="{{ url_for('new_tournament') }}" class="btn btn-sm btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M12 5v14"></path><path d="M5 12h14"></path></svg>
            New Tournament
        </a>
    </div>
    <div class="card-body">
        {% if tournaments %}
            <div class="table-responsive">
                <table class="table table-bordered" id="tournaments-table" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Season</th>
                            <th>Year</th>
                            <th>Status</th>
                            <th>Teams</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tournament in tournaments %}
                            <tr>
                                <td>{{ tournament.name }}</td>
                                <td>{{ tournament.season or 'N/A' }}</td>
                                <td>{{ tournament.year }}</td>
                                <td>
                                    {% if tournament.is_archived %}
                                        <span class="badge bg-danger">Archived</span>
                                    {% elif tournament.is_active %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inactive</span>
                                    {% endif %}
                                    
                                    <span class="badge bg-info">{{ tournament.status | title }}</span>
                                    
                                    {% if tournament.registration_open %}
                                        <span class="badge bg-primary">Registration Open</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">Registration Closed</span>
                                    {% endif %}
                                </td>
                                <td>{{ tournament.teams|length }} / {{ tournament.max_teams }}</td>
                                <td class="text-center">
                                    <div class="btn-group">
                                        <a href="{{ url_for('edit_tournament', tournament_id=tournament.id) }}" class="btn btn-sm btn-outline-primary">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3Z"></path></svg>
                                        </a>
                                        
                                        {% if not tournament.is_archived %}
                                            <button class="btn btn-sm btn-outline-danger archive-btn" data-tournament-id="{{ tournament.id }}">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                                            </button>
                                        {% endif %}
                                        
                                        <button class="btn btn-sm btn-outline-success generate-bracket-btn" data-tournament-id="{{ tournament.id }}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 18v-6a9 9 0 0 1 18 0v6"></path><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"></path></svg>
                                        </button>
                                    </div>
                                    
                                    {% if tournament.is_active %}
                                        <div class="mt-2">
                                            <select class="form-select form-select-sm status-select" data-tournament-id="{{ tournament.id }}">
                                                <option value="registration" {% if tournament.status == 'registration' %}selected{% endif %}>Registration</option>
                                                <option value="in_progress" {% if tournament.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                                                <option value="completed" {% if tournament.status == 'completed' %}selected{% endif %}>Completed</option>
                                            </select>
                                            
                                            <div class="form-check form-switch mt-2">
                                                <input class="form-check-input registration-toggle" type="checkbox" id="reg-toggle-{{ tournament.id }}" data-tournament-id="{{ tournament.id }}" {% if tournament.registration_open %}checked{% endif %}>
                                                <label class="form-check-label" for="reg-toggle-{{ tournament.id }}">Registration Open</label>
                                            </div>
                                        </div>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <p class="text-muted mb-0">No tournaments found</p>
                <a href="{{ url_for('new_tournament') }}" class="btn btn-primary mt-3">Create Your First Tournament</a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle archive tournament button clicks
    const archiveButtons = document.querySelectorAll('.archive-btn');
    archiveButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tournamentId = this.dataset.tournamentId;
            if (confirm('Are you sure you want to archive this tournament? This cannot be undone.')) {
                // Send AJAX request to archive tournament
                fetch(`/admin/tournaments/${tournamentId}/archive`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('Error: ' + (data.message || 'Failed to archive tournament'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error archiving tournament');
                });
            }
        });
    });
    
    // Handle generate bracket button clicks
    const generateButtons = document.querySelectorAll('.generate-bracket-btn');
    generateButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tournamentId = this.dataset.tournamentId;
            if (confirm('Are you sure you want to regenerate the bracket? This will reset all match results.')) {
                // Send AJAX request to generate bracket
                fetch(`/admin/brackets/${tournamentId}/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Bracket generated successfully');
                    } else {
                        alert('Error: ' + (data.message || 'Failed to generate bracket'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error generating bracket');
                });
            }
        });
    });
    
    // Handle tournament status changes
    const statusSelects = document.querySelectorAll('.status-select');
    statusSelects.forEach(select => {
        select.addEventListener('change', function() {
            const tournamentId = this.dataset.tournamentId;
            const status = this.value;
            
            // Send AJAX request to update tournament status
            fetch(`/admin/tournaments/${tournamentId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: `status=${status}&registration=${document.getElementById('reg-toggle-' + tournamentId).checked}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Success - no need to reload
                } else {
                    alert('Error: ' + (data.message || 'Failed to update tournament status'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating tournament status');
            });
        });
    });
    
    // Handle registration toggle changes
    const registrationToggles = document.querySelectorAll('.registration-toggle');
    registrationToggles.forEach(toggle => {
        toggle.addEventListener('change', function() {
            const tournamentId = this.dataset.tournamentId;
            const registration = this.checked;
            
            // Find the corresponding status select
            const statusSelect = document.querySelector(`.status-select[data-tournament-id="${tournamentId}"]`);
            const status = statusSelect.value;
            
            // Send AJAX request to update tournament registration status
            fetch(`/admin/tournaments/${tournamentId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: `status=${status}&registration=${registration}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Success - no need to reload
                } else {
                    alert('Error: ' + (data.message || 'Failed to update registration status'));
                    // Revert toggle to original state
                    this.checked = !registration;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating registration status');
                // Revert toggle to original state
                this.checked = !registration;
            });
        });
    });
});
</script>
{% endblock %}